<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Berichtsheft Dashboard</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* Dein Original CSS (unver√§ndert √ºbernommen) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: #000000; min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { background: #1a1a1a; border-radius: 12px; padding: 30px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 1px solid #2a2a2a; }
        h1 { color: #e5e5e5; font-size: 28px; margin-bottom: 10px; }
        .subtitle { color: #8a8a8a; font-size: 14px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        @media (max-width: 968px) { .grid { grid-template-columns: 1fr; } }
        .card { background: #1a1a1a; border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 1px solid #2a2a2a; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #2a2a2a; }
        .card-title { font-size: 20px; font-weight: 600; color: #e5e5e5; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
        .status-success { background: #1a3a2a; color: #4ade80; border: 1px solid #2a5a3a; }
        .status-failed { background: #3a1a1a; color: #f87171; border: 1px solid #5a2a2a; }
        .status-running { background: #2a2a3a; color: #a78bfa; border: 1px solid #3a3a5a; } /* Umbenannt von pending zu running */
        .status-waiting { background: #3a3a1a; color: #fbbf24; border: 1px solid #5a5a2a; }
        .run-list { list-style: none; }
        .subject-grid { display: grid; gap: 15px; }
        .subject-item { background: #0f0f0f; padding: 15px; border-radius: 8px; border-left: 4px solid #5a5a5a; }
        .subject-label { font-weight: 600; color: #a5a5a5; margin-bottom: 8px; font-size: 14px; }
        .subject-content { width: 100%; padding: 10px; border: 1px solid #3a3a3a; border-radius: 6px; font-size: 14px; font-family: inherit; resize: vertical; min-height: 80px; background: #1a1a1a; color: #e5e5e5; }
        .subject-content:focus { outline: none; border-color: #6a6a6a; box-shadow: 0 0 0 3px rgba(106, 106, 106, 0.1); }
        .button { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
        .button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .button-primary { background: #3a3a3a; color: #e5e5e5; }
        .button-primary:hover { background: #4a4a4a; }
        .button-success { background: #1a3a2a; color: #4ade80; border: 1px solid #2a5a3a; }
        .button-success:hover { background: #2a4a3a; }
        .button-secondary { background: #2a2a2a; color: #a5a5a5; border: 1px solid #3a3a3a; }
        .button-secondary:hover { background: #3a3a3a; }
        .button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .actions { display: flex; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 2px solid #2a2a2a; }
        .empty-state { text-align: center; padding: 40px 20px; color: #6a6a6a; }
        .empty-state svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.5; }
        .loading { text-align: center; padding: 20px; color: #6a6a6a; }
        .spinner { border: 3px solid #2a2a2a; border-top: 3px solid #6a6a6a; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .notification { position: fixed; top: 20px; right: 20px; padding: 16px 24px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: none; align-items: center; gap: 12px; z-index: 1000; animation: slideIn 0.3s ease; color: #e5e5e5; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .notification.show { display: flex; }
        .notification.success { border-left: 4px solid #4ade80; }
        .notification.error { border-left: 4px solid #f87171; }
        
        /* Token Input Style */
        .token-input { background: #0f0f0f; border: 1px solid #3a3a3a; color: #e5e5e5; padding: 8px; border-radius: 6px; width: 100%; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö Berichtsheft Dashboard</h1>
            <p class="subtitle">Realtime Status via Firebase & GitHub Actions</p>
        </header>

        <div class="grid">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">‚öôÔ∏è Einstellungen</h2>
                </div>
                <div style="color: #8a8a8a; font-size: 14px; margin-bottom: 10px;">
                    GitHub Personal Access Token (Repo Scope) wird ben√∂tigt, um Actions zu starten.
                    Wird nicht gespeichert.
                </div>
                <input type="password" id="ghToken" class="token-input" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                <div style="margin-top: 20px;">
                     <h3 style="color:#e5e5e5; font-size:16px;">Letztes Update:</h3>
                     <p id="lastRunDate" style="color:#4ade80; font-family:monospace;">-</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Aktueller Status</h2>
                    <span class="status-badge status-waiting" id="statusBadge">Verbinde...</span>
                </div>
                <div id="statusContent">
                    <div class="empty-state">
                        <div class="spinner" id="mainSpinner"></div>
                        <p id="statusMessage">Lade Daten aus Firebase...</p>
                    </div>
                </div>
                <div class="actions">
                    <button class="button button-primary" id="btnRun1" onclick="startExtractRun()">
                        ‚ñ∂Ô∏è Run 1: Inhalte Laden
                    </button>
                </div>
            </div>
        </div>

        <div class="card" id="editorCard" style="display: none;">
            <div class="card-header">
                <h2 class="card-title">Berichtsheft Inhalte bearbeiten</h2>
                <span class="status-badge status-waiting">Wartet auf Trigger</span>
            </div>
            
            <div class="subject-grid">
                <div class="subject-item"><div class="subject-label">Montag - EVP</div><textarea class="subject-content" id="evp1"></textarea></div>
                <div class="subject-item"><div class="subject-label">Montag - Deutsch</div><textarea class="subject-content" id="deutsch"></textarea></div>
                <div class="subject-item"><div class="subject-label">Montag - STDM</div><textarea class="subject-content" id="stdm"></textarea></div>
                <div class="subject-item"><div class="subject-label">Montag - Kryptologie</div><textarea class="subject-content" id="kryp"></textarea></div>
                <div class="subject-item"><div class="subject-label">Freitag - GID</div><textarea class="subject-content" id="gid"></textarea></div>
                <div class="subject-item"><div class="subject-label">Freitag - Englisch</div><textarea class="subject-content" id="englisch"></textarea></div>
                <div class="subject-item"><div class="subject-label">Freitag - EVP (2)</div><textarea class="subject-content" id="evp2"></textarea></div>
            </div>

            <div class="actions">
                <button class="button button-success" id="btnRun2" onclick="startSubmitRun()">
                    ‚úÖ Run 2: Ins IHK eintragen
                </button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <span id="notificationText"></span>
    </div>

    <script>
        // --- 1. KONFIGURATION HIER EINTRAGEN ---
        const firebaseConfig = {
            databaseURL: "https://autoberichtsheft-default-rtdb.europe-west1.firebasedatabase.app/", // <--- HIER DEINE URL
        };
        const GITHUB_USER = 'yildizog'; 
        const GITHUB_REPO = 'AutoBerichtsheft';

        // --- Firebase Init ---
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentFirebaseData = null;

        // --- Notification Helper ---
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const text = document.getElementById('notificationText');
            text.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => { notification.classList.remove('show'); }, 4000);
        }

        // --- REALTIME LISTENER ---
        db.ref('status').on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return;
            currentFirebaseData = data;

            // Update Header Infos
            document.getElementById('lastRunDate').textContent = data.lastRun || '-';
            document.getElementById('statusMessage').textContent = data.message;
            
            const badge = document.getElementById('statusBadge');
            badge.className = `status-badge status-${data.status === 'pending' ? 'running' : data.status}`;
            
            if(data.status === 'running') badge.textContent = 'L√ÑUFT...';
            else if(data.status === 'waiting') badge.textContent = 'WARTET AUF PR√úFUNG';
            else if(data.status === 'success') badge.textContent = 'FERTIG';
            else if(data.status === 'failed') badge.textContent = 'FEHLER';
            else badge.textContent = data.status;

            // Spinner Logik
            const spinner = document.getElementById('mainSpinner');
            if (data.status === 'running') spinner.style.display = 'block';
            else spinner.style.display = 'none';

            // Editor Logik
            const editorCard = document.getElementById('editorCard');
            
            // Wenn Inhalte da sind, f√ºlle Editor (nur wenn User nicht tippt)
            if (data.content && typeof data.content === 'object') {
                editorCard.style.display = 'block';
                const fields = ['evp1', 'deutsch', 'stdm', 'kryp', 'gid', 'englisch', 'evp2'];
                fields.forEach(field => {
                    const el = document.getElementById(field);
                    if (document.activeElement !== el) {
                        el.value = data.content[field] || '';
                    }
                });
            }
        });

        // --- FUNKTIONEN ---

        // Run 1 starten (Scraper)
        async function startExtractRun() {
            const token = document.getElementById('ghToken').value;
            if(!token) return showNotification("Bitte GitHub Token eingeben!", "error");

            // UI Feedback sofort geben
            db.ref('status').update({ status: 'running', message: 'Starte Scraper...' });

            try {
                // Wir nutzen den Workflow Dispatch Trigger, den wir definiert haben
                const res = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/actions/workflows/scrape_schedule.yml/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({ ref: 'main' }) // oder dein branch name
                });

                if(res.ok) showNotification("Run 1 erfolgreich getriggert", "success");
                else throw new Error("GitHub Error: " + res.status);
            } catch (e) {
                showNotification(e.message, "error");
                db.ref('status').update({ status: 'failed', message: 'Trigger fehlgeschlagen' });
            }
        }

        // Run 2 starten (Upload mit Daten)
        async function startSubmitRun() {
            const token = document.getElementById('ghToken').value;
            if(!token) return showNotification("Bitte GitHub Token eingeben!", "error");

            // Daten aus dem Editor sammeln
            const contentPayload = {
                evp1: document.getElementById('evp1').value,
                deutsch: document.getElementById('deutsch').value,
                stdm: document.getElementById('stdm').value,
                kryp: document.getElementById('kryp').value,
                gid: document.getElementById('gid').value,
                englisch: document.getElementById('englisch').value,
                evp2: document.getElementById('evp2').value
            };

            // Status update
            db.ref('status').update({ status: 'running', message: 'Sende Daten an IHK...' });

            try {
                const res = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        event_type: 'trigger-ihk-upload',
                        client_payload: { text: JSON.stringify(contentPayload) } // Wir senden das JSON Objekt als String
                    })
                });

                if(res.ok) showNotification("Run 2 gestartet! Bitte warten.", "success");
                else throw new Error("GitHub Error: " + res.status);
            } catch (e) {
                showNotification(e.message, "error");
                db.ref('status').update({ status: 'waiting', message: 'Upload Trigger fehlgeschlagen' });
            }
        }
    </script>
</body>
</html>